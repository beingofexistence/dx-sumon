/*
 * To avoid installing `oclif` as a dependency, this file mimics
 * how the manifest is generated by @oclif/core.
 * https://github.com/oclif/oclif/blob/main/src/commands/manifest.ts#L76
 */

import path from 'node:path';
import {fileURLToPath} from 'node:url';
import {writeFile, access} from 'node:fs/promises';
import {Plugin} from '@oclif/core';

console.log('\n', 'Generating Oclif manifest...');

const cwd = fileURLToPath(new URL('..', import.meta.url));

if (
  !(await access(path.join(cwd, 'dist', 'commands', 'hydrogen'))
    .then(() => true)
    .catch(() => false))
) {
  throw new Error(
    '`dist/commands/hydrogen` directory not found. Please build the CLI project first.',
  );
}

const plugin = new Plugin({
  root: cwd,
  type: 'core',
  ignoreManifest: true,
  errorOnManifestCreate: true,
});

await plugin.load(true);

await writeFile(
  path.join(cwd, 'oclif.manifest.json'),
  JSON.stringify(plugin.manifest, null, 2),
);

console.log('', 'Oclif manifest generated.\n');
